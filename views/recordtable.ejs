<!DOCTYPE html>
<html lang="en">
    <%- include('./partials/head.ejs') %>
<body>
    <div class="student-record-table-container">

        <%- include('./partials/navigation.ejs') %>
        <div class="student-record-table-subcontainer">
            <div class="search-div">
                <label for="search-fname">First Name</label>
                <input type="text" class="search-fname">
                <label for="search-lname">Last Name</label>
                <input type="text" class="search-lname">
                <button type="button" class="search">Search</button>
            </div>
            
            <table border="1" class="student-records">
                <tr>
                    <th>First Name</th>
                    <th>Middle Name</th>
                    <th>Last Name</th>
                    <th>Grade/Level</th>
                    <th>Section</th>
                    <th>Department</th>
                    <th>LRN</th>
                    <th>Actions</th>
                </tr>

                <% for(let x = 0;x < record.length ; x++) { %>
                    <tr class="data-rows">
                        <td><%= record[x].firstname %></td>
                        <td><%= record[x].middlename %></td>
                        <td><%= record[x].lastname %></td>
                        <td><%= record[x].grade %></td>
                        <td><%= record[x].section.name %></td>
                        <td><%= record[x].department %></td>
                        <td><%= record[x].lrn %></td>
                        <td>
                            <a href="/student-record/<%= record[x]._id %>">View Entry</a>
                        </td>
                    </tr>
                <% } %>        
            </table>
        </div>

    </div>   

    <script>
        const search = document.querySelector('.search')
        const data = document.querySelectorAll('.data-rows')
        const studentTable = document.querySelector('.student-records')
        const fname = document.querySelector('.search-fname')
        const lname = document.querySelector('.search-lname')

        const records = '<%- JSON.stringify(record) %>'
        const recordsData = JSON.parse(records)

        search.addEventListener('click', () => {
            const fnameRegex = new RegExp(`^${fname.value}$`,'i')
            const lnameRegex = new RegExp(`^${lname.value}$`,'i')

            // button does nothing if search box is empty

            if (fname.value === '' && lname.value === ''){
                return null;
            }

            //clears current displayed data to be replaced by search query results

            data.forEach(tr => tr.remove())

            //filters the records database based on the user query

            const filteredRecords = recordsData.filter(rec => {

                if (fname.value !== '' && lname.value === '') {
                    return fnameRegex.test(rec.firstname)
                } else if (fname.value === '' && lname.value !== '') {
                    return lnameRegex.test(rec.lastname)
                }
                return fnameRegex.test(rec.firstname) && lnameRegex.test(rec.lastname)
            })

            //display the search results for user viewing
            
            filteredRecords.forEach(rec => {
                const tr = document.createElement('tr')
                const info = [rec.firstname, rec.middlename, rec.lastname, rec.grade, rec.section.name, rec.department, rec.lrn, rec.dob]

                for(let x = 0; x < 8; x++) {
                    const td = document.createElement('td')

                    if (x <= 6){
                        const text = document.createTextNode(info[x])
                        td.appendChild(text)
                    } else {
                        const a = document.createElement('a')
                        const text = document.createTextNode('View Entry')
                        a.appendChild(text)
                        a.href = `/student-record/${rec._id}`
                        td.appendChild(a)
                    }
                    
                    tr.appendChild(td)
                }
                studentTable.appendChild(tr)
            })
        })
        
    </script>
</body>
</html>